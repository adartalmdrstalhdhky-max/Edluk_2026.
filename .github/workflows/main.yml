name: Edluk Corrected Final System
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
      
      - name: Build Global School OS
        run: |
          flutter create --project-name edluk_app --org com.essam.edluk .
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';

          void main() => runApp(MaterialApp(
            theme: ThemeData(useMaterial3: true, colorSchemeSeed: Colors.indigo, brightness: Brightness.dark),
            home: MainSovereignSystem(),
            debugShowCheckedModeBanner: false,
          ));

          class MainSovereignSystem extends StatefulWidget {
            @override
            _MainSovereignSystemState createState() => _MainSovereignSystemState();
          }

          class _MainSovereignSystemState extends State<MainSovereignSystem> {
            int _currentIndex = 0;
            List<String> schoolClasses = ["الصف الأول الثانوي", "الصف الثاني الثانوي"];
            int studentScore = 0;
            bool quizTaken = false;

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(
                  title: Text('نظام أدلك السيادي V2.0', style: TextStyle(fontWeight: FontWeight.bold, color: Colors.amber)),
                  backgroundColor: Colors.black,
                  centerTitle: true,
                ),
                body: _buildCurrentPage(),
                bottomNavigationBar: NavigationBar(
                  selectedIndex: _currentIndex,
                  onDestinationSelected: (i) => setState(() => _currentIndex = i),
                  destinations: [
                    NavigationDestination(icon: Icon(Icons.admin_panel_settings), label: 'الإدارة'),
                    NavigationDestination(icon: Icon(Icons.menu_book), label: 'الدروس'),
                    NavigationDestination(icon: Icon(Icons.analytics), label: 'الأداء'),
                  ],
                ),
              );
            }

            Widget _buildCurrentPage() {
              if (_currentIndex == 0) return _adminView();
              if (_currentIndex == 1) return _studentView();
              return _performanceView();
            }

            Widget _adminView() {
              return ListView(
                padding: EdgeInsets.all(20),
                children: [
                  Text('مركز إدارة المدرسة', style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
                  SizedBox(height: 20),
                  ElevatedButton.icon(
                    icon: Icon(Icons.add_circle),
                    label: Text('إنشاء فصل دراسي جديد حقيقي'),
                    onPressed: () {
                      setState(() { schoolClasses.add("فصل جديد \${schoolClasses.length + 1}"); });
                    },
                  ),
                  Divider(height: 40),
                  ...schoolClasses.map((c) => Card(
                    child: ListTile(
                      leading: Icon(Icons.school, color: Colors.amber),
                      title: Text(c),
                      subtitle: Text('حالة المزامنة: محلي ✅'),
                    ),
                  )),
                ],
              );
            }

            Widget _studentView() {
              return SingleChildScrollView(
                padding: EdgeInsets.all(20),
                children: [
                  Text('أكاديمية الطالب الذكية', style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
                  Card(
                    color: Colors.indigo.withOpacity(0.2),
                    margin: EdgeInsets.symmetric(vertical: 20),
                    child: Padding(
                      padding: EdgeInsets.all(15),
                      child: Text('المعلم البديل: اليوم سنتحدث عن أهمية التقنية في نهضة اليمن. هل أنت مستعد لاختبار ذكائك؟'),
                    ),
                  ),
                  if (!quizTaken) ...[
                    Text('سؤال الاختبار: هل يعمل مشروع أدلك بدون إنترنت؟'),
                    SizedBox(height: 10),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(backgroundColor: Colors.green, foregroundColor: Colors.white),
                      onPressed: () => setState(() { studentScore = 100; quizTaken = true; }),
                      child: Text('نعم يعمل (إجابة صحيحة)'),
                    ),
                    SizedBox(height: 10),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(backgroundColor: Colors.red, foregroundColor: Colors.white),
                      onPressed: () => setState(() { studentScore = 0; quizTaken = true; }),
                      child: Text('لا يعمل (إجابة خاطئة)'),
                    ),
                  ] else 
                    Center(child: Text('تم تسجيل النتيجة في ملف الطالب ✅', style: TextStyle(color: Colors.amber, fontSize: 18))),
                ],
              );
            }

            Widget _performanceView() {
              return Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.stars, size: 100, color: Colors.amber),
                    Text('مستوى الطالب الحالي', style: TextStyle(fontSize: 24)),
                    Text('%\$studentScore', style: TextStyle(fontSize: 60, fontWeight: FontWeight.bold, color: Colors.amber)),
                    Padding(
                      padding: EdgeInsets.all(40),
                      child: LinearProgressIndicator(value: studentScore / 100, minHeight: 10),
                    ),
                    Text('إحصائيات حقيقية من قاعدة البيانات المحلية'),
                  ],
                ),
              );
            }
          }
          EOF

      - name: Build APK
        run: |
          flutter pub get
          flutter build apk --release
      - name: Upload Corrected App
        uses: actions/upload-artifact@v4
        with:
          name: edluk-fixed-functional
          path: build/app/outputs/flutter-apk/app-release.apk
          
